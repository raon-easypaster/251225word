import React, { useState, useEffect } from 'react';
import { ChevronLeft, ChevronRight, CheckCircle2, Circle, MessageCircle, Quote, Heart, Calendar } from 'lucide-react';

const devotionalData = [
  {
    day: 1,
    title: "먼저 찾아오시는 하나님의 선행적 은총",
    verse: "미가 5:2",
    reflection: "베들레헴처럼 작고 보잘것없는 나의 마음에 하나님께서 먼저 찾아오셨음을 느낀 적이 있나요? 우리가 하나님을 알기도 전에 먼저 사랑하신 그 은혜를 깊이 묵상해 봅시다.",
    action: "오늘 하루, 나의 조건이나 공로가 아니라 하나님의 전적인 사랑으로 내가 선택받았음을 고백하며 '하나님, 저를 먼저 사랑해 주셔서 감사합니다'라고 세 번 진심을 담아 선포하세요.",
    prayer: "사랑의 주님, 자격 없는 저를 먼저 사랑하시고 제 삶의 베들레헴에 찾아와 주셔서 감사합니다. 오늘 그 선행적 은총에 기대어 기쁨으로 하루를 시작하게 하소서."
  },
  {
    day: 2,
    title: "작은 것에서 시작되는 성결의 은총",
    verse: "미가 5:2",
    reflection: "유다 족속 중 가장 작은 베들레헴을 택하신 하나님은 오늘 우리의 소박한 순종을 기뻐하십니다. 오늘 내가 주님 앞에서 거룩하게 구별해야 할 작은 습관이나 언어는 무엇인가요?",
    action: "내 삶에서 무심코 지나쳤던 사소한 불평이나 습관 하나를 정하여, 오늘 하루는 그것을 멈추고 대신 감사의 말을 그 자리에 심어보세요.",
    prayer: "주님, 화려한 도시가 아닌 작은 마을에 오신 주님을 닮기 원합니다. 제 작은 일상의 순간들이 주님의 거룩함을 드러내는 거룩한 베들레헴이 되게 하소서."
  },
  {
    day: 3,
    title: "메마른 마음을 적시는 성육신의 사랑",
    verse: "미가 5:3",
    reflection: "분주함과 삶의 무게로 팍팍해진 내 마음에 주님은 여전히 따뜻하게 찾아오고 계십니다. 주님이 내 마음에 오셔서 어루만져 주시고 회복시켜 주시기를 바라는 아픔이나 결핍은 무엇인가요?",
    action: "오늘 조용한 시간에 5분간 머물며, 예수님이 이 땅에 오신 의미를 생각하며 주님이 나의 상처를 따뜻하게 안아주시는 평안의 시간을 가지세요.",
    prayer: "메마른 땅에 단비처럼 오신 예수님, 지치고 상한 제 마음을 주님의 성육신하신 사랑으로 위로하여 주시고 다시 일어설 영적인 힘을 공급하여 주옵소서."
  },
  {
    day: 4,
    title: "사회적 성결: 소외된 베들레헴을 찾아서",
    verse: "미가 5:4",
    reflection: "예수님은 세상의 중심이 아닌 변두리에서 탄생하셨습니다. 우리 주변에 베들레헴처럼 사람들의 관심에서 멀어져 소외된 이웃은 누구인가요? 그들에게 어떻게 주님의 사랑을 구체적으로 흘려보낼 수 있을까요?",
    action: "평소 연락이 뜸했거나 외로워 보이는 지인에게 따뜻한 격려의 메시지를 보내거나 작은 정성을 나누며 성탄의 기쁨을 함께 나누세요.",
    prayer: "낮은 곳으로 임하신 주님, 제가 제 삶의 안위만 돌보지 않게 하시고 주님의 시선이 머무는 소외된 곳에 제 발걸음과 마음도 머물게 하소서."
  },
  {
    day: 5,
    title: "내 삶의 중심에 예수님 모시기",
    verse: "요한복음 1:46",
    reflection: "나다나엘처럼 혹시 '내 삶의 초라한 형편에서 무슨 선한 것이 나겠어?'라며 주님의 능력을 제한하고 있지는 않나요? 내 삶의 모든 영역에 주님을 진정한 주인으로 모셔드리고 있습니까?",
    action: "오늘 마주하는 결정의 순간마다 '주님이라면 어떻게 하셨을까?'를 먼저 질문하고, 내 욕심이 아닌 주님이 기뻐하시는 방향으로 한 가지만 결정해 보세요.",
    prayer: "주님, 제 편견과 불신을 내려놓습니다. 보잘것없는 제 삶의 주권자가 되어 주셔서 오직 주님만이 영광 받으시는 복된 삶이 되게 하소서."
  },
  {
    day: 6,
    title: "완전한 사랑으로 나아가는 길",
    verse: "미가 5:4",
    reflection: "여호와의 위엄을 의지하여 선한 목자가 되신 예수님은 우리를 완전한 사랑의 상태로 인도하십니다. 나는 오늘 그분의 인도하심을 온전히 신뢰하며 내 삶을 맡기고 있나요?",
    action: "혼자 힘으로 해결하려 애쓰던 걱정거리를 하나 정하여, 오늘 하루는 주님께 온전히 맡겨드리고 주님이 주시는 평안 속에서 안식해 보세요.",
    prayer: "선한 목자 되신 주님, 주님의 위엄과 사랑 안에서 참된 안식을 누립니다. 저를 온전한 사랑과 성결의 길로 매일매일 인도하여 주옵소서."
  },
  {
    day: 7,
    title: "기억하고 전파하는 성탄의 증인",
    verse: "미가 5:4",
    reflection: "성탄은 과거의 박제된 사건이 아니라 오늘 우리 삶에서 생생하게 재현되어야 할 복음입니다. 한 주간 묵상한 성탄의 의미를 누구에게, 어떤 삶의 모습으로 증거하시겠습니까?",
    action: "성탄의 기쁨을 담은 나만의 짧은 감사 고백을 적어보고, 가족이나 친구에게 공유하며 주님이 오신 소식을 축하하는 시간을 가지세요.",
    prayer: "영원부터 계셨고 우리를 위해 오신 주님, 성탄의 소식이 제 삶의 끊이지 않는 노래가 되게 하소서. 세상 끝까지 주님의 사랑을 전하는 성탄의 통로로 살게 하소서."
  }
];

export default function App() {
  const [currentDay, setCurrentDay] = useState(0);
  const [completedDays, setCompletedDays] = useState(new Array(7).fill(false));
  const [aiInsight, setAiInsight] = useState("");
  const [loading, setLoading] = useState(false);

  const currentData = devotionalData[currentDay];

  const toggleComplete = (index) => {
    const newCompleted = [...completedDays];
    newCompleted[index] = !newCompleted[index];
    setCompletedDays(newCompleted);
  };

  const handleDeepenMeditation = async () => {
    setLoading(true);
    setAiInsight("");
    const apiKey = ""; 
    const userQuery = `성경 구절 ${currentData.verse}와 주제 '${currentData.title}'에 대해 오늘날 우리가 실천할 수 있는 더 깊은 영적 의미와 묵상 포인트를 3가지 알려줘.`;
    const systemPrompt = "당신은 따뜻하고 지혜로운 신학자이자 목회자입니다. 사용자에게 성경의 깊은 의미를 친절하게 설명해주세요. 답변은 한국어로 해주세요.";

    try {
      let delay = 1000;
      for (let i = 0; i < 5; i++) {
        try {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: userQuery }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] }
            })
          });
          const result = await response.json();
          const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
          if (text) {
            setAiInsight(text);
            break;
          }
        } catch (e) {
          if (i === 4) throw e;
          await new Promise(res => setTimeout(res, delay));
          delay *= 2;
        }
      }
    } catch (error) {
      setAiInsight("묵상을 불러오는 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-[#fdfcfb] text-slate-800 font-sans p-4 md:p-8">
      <div className="max-w-2xl mx-auto">
        {/* Header */}
        <header className="text-center mb-10">
          <h1 className="text-2xl md:text-3xl font-bold text-amber-900 mb-2 leading-tight">
            베들레헴 에브라다에 오신 왕
          </h1>
          <p className="text-amber-700 font-medium bg-amber-50 inline-block px-4 py-1 rounded-full text-sm">
            성탄의 참된 의미를 찾아서
          </p>
        </header>

        {/* Day Selector */}
        <div className="flex justify-between items-center mb-8 overflow-x-auto pb-2 no-scrollbar gap-2">
          {devotionalData.map((d, idx) => (
            <button
              key={idx}
              onClick={() => {
                setCurrentDay(idx);
                setAiInsight("");
              }}
              className={`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center font-bold transition-all duration-300 ${
                currentDay === idx
                  ? 'bg-amber-600 text-white shadow-lg scale-110'
                  : completedDays[idx]
                  ? 'bg-amber-100 text-amber-600 border border-amber-200'
                  : 'bg-white text-slate-400 border border-slate-200 hover:border-amber-300'
              }`}
            >
              {d.day}
            </button>
          ))}
        </div>

        {/* Main Content Card */}
        <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden transition-all duration-500">
          <div className="bg-amber-600 p-6 text-white relative">
            <div className="flex justify-between items-center mb-2">
              <span className="text-amber-200 text-xs font-black uppercase tracking-widest flex items-center gap-1">
                <Calendar size={14} /> DAY {currentData.day}
              </span>
              <button 
                onClick={() => toggleComplete(currentDay)}
                className="hover:scale-110 transition-transform"
              >
                {completedDays[currentDay] ? <CheckCircle2 size={24} className="text-amber-200" /> : <Circle size={24} className="text-amber-200 opacity-50" />}
              </button>
            </div>
            <h2 className="text-xl md:text-2xl font-bold leading-snug">{currentData.title}</h2>
            <p className="mt-2 text-amber-100 italic flex items-center gap-2">
              <Quote size={14} className="rotate-180" /> {currentData.verse}
            </p>
          </div>

          <div className="p-6 space-y-8">
            {/* Reflection */}
            <section>
              <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Reflection</h3>
              <div className="bg-slate-50 p-5 rounded-2xl border-l-4 border-amber-400">
                <p className="text-lg font-medium leading-relaxed italic text-slate-700">
                  "{currentData.reflection}"
                </p>
              </div>
            </section>

            {/* Action */}
            <section>
              <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Today's Action</h3>
              <div className="flex gap-4 items-start group">
                <div 
                  onClick={() => toggleComplete(currentDay)}
                  className={`mt-1 cursor-pointer transition-colors ${completedDays[currentDay] ? 'text-green-500' : 'text-slate-300'}`}
                >
                  <CheckCircle2 size={24} />
                </div>
                <p className={`text-base leading-relaxed ${completedDays[currentDay] ? 'text-slate-400 line-through' : 'text-slate-800'}`}>
                  {currentData.action}
                </p>
              </div>
            </section>

            {/* Prayer */}
            <section className="pt-6 border-t border-slate-50">
              <h3 className="text-xs font-bold text-amber-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                <Heart size={14} /> Prayer
              </h3>
              <p className="text-slate-600 italic leading-relaxed">
                {currentData.prayer}
              </p>
            </section>

            {/* AI Depth Insight Button */}
            <div className="pt-4">
              {aiInsight ? (
                <div className="bg-amber-50 p-5 rounded-2xl border border-amber-100 text-slate-700 text-sm leading-relaxed animate-in fade-in slide-in-from-bottom-2">
                  <div className="font-bold text-amber-800 mb-2 flex items-center gap-2">
                    <MessageCircle size={16} /> 깊은 묵상을 위한 도우미
                  </div>
                  <div className="whitespace-pre-wrap">{aiInsight}</div>
                  <button 
                    onClick={() => setAiInsight("")}
                    className="mt-4 text-xs text-amber-600 font-bold hover:underline"
                  >
                    닫기
                  </button>
                </div>
              ) : (
                <button
                  onClick={handleDeepenMeditation}
                  disabled={loading}
                  className="w-full py-4 rounded-2xl border-2 border-dashed border-slate-200 text-slate-400 hover:border-amber-300 hover:text-amber-600 transition-all flex items-center justify-center gap-2 font-medium"
                >
                  {loading ? (
                    <span className="flex items-center gap-2 animate-pulse">
                      <div className="w-2 h-2 bg-amber-400 rounded-full animate-bounce" />
                      묵상을 준비하고 있습니다...
                    </span>
                  ) : (
                    <>
                      <MessageCircle size={18} />
                      주제에 대해 더 깊이 묵상하기
                    </>
                  )}
                </button>
              )}
            </div>
          </div>
        </div>

        {/* Navigation Buttons */}
        <div className="flex justify-between items-center mt-8 px-2">
          <button
            onClick={() => {
              setCurrentDay(Math.max(0, currentDay - 1));
              setAiInsight("");
            }}
            disabled={currentDay === 0}
            className={`flex items-center gap-1 text-sm font-bold ${currentDay === 0 ? 'text-slate-300' : 'text-amber-700 hover:translate-x-[-4px] transition-transform'}`}
          >
            <ChevronLeft size={20} /> 이전 날
          </button>
          
          <div className="text-xs font-bold text-slate-400 bg-white px-3 py-1 rounded-full border border-slate-100 shadow-sm">
            {currentDay + 1} / 7
          </div>

          <button
            onClick={() => {
              setCurrentDay(Math.min(6, currentDay + 1));
              setAiInsight("");
            }}
            disabled={currentDay === 6}
            className={`flex items-center gap-1 text-sm font-bold ${currentDay === 6 ? 'text-slate-300' : 'text-amber-700 hover:translate-x-[4px] transition-transform'}`}
          >
            다음 날 <ChevronRight size={20} />
          </button>
        </div>

        <footer className="mt-16 text-center text-slate-400 text-xs pb-10">
          <p>© 2024 라온동행교회 주간 묵상집</p>
          <p className="mt-1">작은 자로 오신 왕을 찬양합니다</p>
        </footer>
      </div>
    </div>
  );
}
